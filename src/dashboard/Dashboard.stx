<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ siteName }} - Analytics</title>
  <script>
    // Configuration - auto-detect from current URL or use overrides
    const urlParams = new URLSearchParams(window.location.search)
    const API_ENDPOINT = window.ANALYTICS_API_ENDPOINT || urlParams.get('api') || window.location.origin
    const SITE_ID = urlParams.get('siteId') || window.ANALYTICS_SITE_ID || ''

    // Sites list
    let availableSites = []
    let sitesLoading = true
    let sitesError = null

    // Dashboard state
    let siteName = "Analytics Dashboard"
    let siteId = SITE_ID
    let dateRange = "Last 30 days"
    let activeView = 'dashboard' // 'dashboard' or 'heatmap'

    // Heatmap state
    let heatmapPages = []
    let selectedHeatmapPage = ''
    let heatmapViewMode = 'click' // 'click' or 'scroll'
    let heatmapClicks = []
    let heatmapTopElements = []
    let heatmapTotalClicks = 0
    let heatmapScrollData = []
    let heatmapAvgScrollDepth = 0
    let heatmapTotalSessions = 0
    let heatmapLoading = false

    // Summary stats
    let stats = {
      realtime: 0,
      people: 0,
      views: 0,
      avgTime: "00:00",
      bounceRate: 0,
      events: 0
    }

    // Table data
    let pages = []
    let referrers = []
    let deviceTypes = []
    let operatingSystems = []
    let browsers = []
    let countries = []
    let campaigns = []
    let events = []
    let timeSeriesData = []

    // Fetch available sites
    async function fetchAvailableSites() {
      sitesLoading = true
      sitesError = null
      try {
        const res = await fetch(`${API_ENDPOINT}/api/sites`)
        if (!res.ok) throw new Error('Failed to fetch sites')
        const data = await res.json()
        availableSites = data.sites || []
        sitesLoading = false
        renderSiteSelector()
      } catch (err) {
        sitesError = err.message || 'Failed to load sites'
        sitesLoading = false
        renderSiteSelector()
      }
    }

    function renderSiteSelector() {
      const container = document.getElementById('site-selector-container')
      if (!container) return

      if (sitesLoading) {
        container.innerHTML = `
          <div class="site-selector-loading">
            <div class="spinner"></div>
            <p>Loading sites...</p>
          </div>
        `
        return
      }

      if (sitesError) {
        container.innerHTML = `
          <div class="site-selector-error">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p>${sitesError}</p>
            <button onclick="fetchAvailableSites()">Try Again</button>
          </div>
        `
        return
      }

      if (availableSites.length === 0) {
        container.innerHTML = `
          <div class="site-selector-empty">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
            </svg>
            <h2>No Sites Found</h2>
            <p>Create a site to start tracking analytics.</p>
          </div>
        `
        return
      }

      container.innerHTML = `
        <div class="site-selector-grid">
          ${availableSites.map(site => `
            <button class="site-card" onclick="selectSite('${site.id}', '${site.name.replace(/'/g, "\\'")}')">
              <div class="site-card-icon">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                </svg>
              </div>
              <div class="site-card-info">
                <span class="site-card-name">${site.name}</span>
                <span class="site-card-domain">${site.domains?.[0] || site.id}</span>
              </div>
              <svg class="site-card-arrow" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </button>
          `).join('')}
        </div>
      `
    }

    function selectSite(id, name) {
      siteId = id
      siteName = name
      document.getElementById('site-selector-screen').style.display = 'none'
      document.getElementById('dashboard-content').style.display = 'block'
      // Update URL without reload
      const url = new URL(window.location.href)
      url.searchParams.set('siteId', id)
      window.history.pushState({}, '', url)
      // Update site name in header
      document.querySelector('.site-selector select').innerHTML = `<option>${name}</option>`
      // Fetch dashboard data
      fetchDashboardData()
    }

    // Fetch data from API
    async function fetchDashboardData() {
      if (!siteId) {
        console.error('No siteId configured. Add ?siteId=YOUR_SITE_ID to the URL.')
        return
      }

      const baseUrl = `${API_ENDPOINT}/api/sites/${siteId}`
      const now = new Date()
      const thirtyDaysAgo = new Date(now)
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)
      const params = `?startDate=${thirtyDaysAgo.toISOString()}&endDate=${now.toISOString()}`

      try {
        // Fetch all data in parallel
        const [statsRes, realtimeRes, pagesRes, referrersRes, devicesRes, browsersRes, countriesRes, timeseriesRes, eventsRes, campaignsRes] = await Promise.all([
          fetch(`${baseUrl}/stats${params}`).then(r => r.json()).catch(() => ({})),
          fetch(`${baseUrl}/realtime`).then(r => r.json()).catch(() => ({ currentVisitors: 0 })),
          fetch(`${baseUrl}/pages${params}`).then(r => r.json()).catch(() => ({ pages: [] })),
          fetch(`${baseUrl}/referrers${params}`).then(r => r.json()).catch(() => ({ referrers: [] })),
          fetch(`${baseUrl}/devices${params}`).then(r => r.json()).catch(() => ({ deviceTypes: [], operatingSystems: [] })),
          fetch(`${baseUrl}/browsers${params}`).then(r => r.json()).catch(() => ({ browsers: [] })),
          fetch(`${baseUrl}/countries${params}`).then(r => r.json()).catch(() => ({ countries: [] })),
          fetch(`${baseUrl}/timeseries${params}`).then(r => r.json()).catch(() => ({ timeSeries: [] })),
          fetch(`${baseUrl}/events${params}`).then(r => r.json()).catch(() => ({ events: [] })),
          fetch(`${baseUrl}/campaigns${params}`).then(r => r.json()).catch(() => ({ campaigns: [] })),
        ])

        // Update stats
        stats = {
          realtime: realtimeRes.currentVisitors || 0,
          people: statsRes.people || 0,
          views: statsRes.views || 0,
          avgTime: statsRes.avgTime || "00:00",
          bounceRate: statsRes.bounceRate || 0,
          events: statsRes.events || 0
        }

        // Update tables
        pages = pagesRes.pages || []
        referrers = referrersRes.referrers || []
        deviceTypes = devicesRes.deviceTypes || []
        operatingSystems = devicesRes.operatingSystems || []
        browsers = browsersRes.browsers || []
        countries = countriesRes.countries || []
        campaigns = campaignsRes.campaigns || []
        events = eventsRes.events || []
        timeSeriesData = timeseriesRes.timeSeries || []

        // Re-render the dashboard
        renderDashboard()
      } catch (error) {
        console.error('Failed to fetch dashboard data:', error)
      }
    }

    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M'
      if (num >= 1000) return (num / 1000).toFixed(1) + 'k'
      return String(num)
    }

    // Heatmap functions
    async function fetchHeatmapPages() {
      if (!siteId) return
      try {
        const res = await fetch(`${API_ENDPOINT}/api/sites/${siteId}/heatmap/pages`)
        const data = await res.json()
        heatmapPages = data.pages || []
        renderHeatmapPageSelector()
      } catch (err) {
        console.error('Failed to fetch heatmap pages:', err)
      }
    }

    async function fetchHeatmapData() {
      if (!siteId || !selectedHeatmapPage) return
      heatmapLoading = true
      renderHeatmapLoading()

      const now = new Date()
      const thirtyDaysAgo = new Date(now)
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)
      const params = `path=${encodeURIComponent(selectedHeatmapPage)}&startDate=${thirtyDaysAgo.toISOString()}&endDate=${now.toISOString()}`

      try {
        if (heatmapViewMode === 'click') {
          const res = await fetch(`${API_ENDPOINT}/api/sites/${siteId}/heatmap/clicks?${params}`)
          const data = await res.json()
          heatmapClicks = data.clicks || []
          heatmapTopElements = data.topElements || []
          heatmapTotalClicks = data.totalClicks || 0
        } else {
          const res = await fetch(`${API_ENDPOINT}/api/sites/${siteId}/heatmap/scroll?${params}`)
          const data = await res.json()
          heatmapScrollData = data.scrollDepths || []
          heatmapAvgScrollDepth = data.avgMaxDepth || 0
          heatmapTotalSessions = data.totalSessions || 0
        }
        renderHeatmap()
      } catch (err) {
        console.error('Failed to fetch heatmap data:', err)
      } finally {
        heatmapLoading = false
      }
    }

    function renderHeatmapPageSelector() {
      const selector = document.getElementById('heatmap-page-select')
      if (!selector) return
      selector.innerHTML = '<option value="">Select a page...</option>' +
        heatmapPages.map(p => `<option value="${p.path}">${p.path} (${p.clickCount || 0} clicks)</option>`).join('')
    }

    function renderHeatmapLoading() {
      const container = document.getElementById('heatmap-viz')
      if (!container) return
      container.innerHTML = `
        <div class="heatmap-loading">
          <div class="spinner"></div>
          <span>Loading heatmap data...</span>
        </div>
      `
    }

    function renderHeatmap() {
      if (heatmapViewMode === 'click') {
        renderClickHeatmap()
      } else {
        renderScrollHeatmap()
      }
      renderHeatmapSidebar()
    }

    function renderClickHeatmap() {
      const container = document.getElementById('heatmap-viz')
      if (!container) return

      if (heatmapClicks.length === 0) {
        container.innerHTML = `
          <div class="heatmap-empty">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
            </svg>
            <p>No click data for this page yet</p>
          </div>
        `
        return
      }

      // Create canvas-based heatmap
      const width = container.offsetWidth
      const height = 500
      const maxCount = Math.max(...heatmapClicks.map(c => c.count), 1)

      container.innerHTML = `
        <div class="heatmap-canvas-container" style="position:relative;width:100%;height:${height}px;background:#1a1f2e;border-radius:8px;overflow:hidden;">
          <canvas id="heatmap-canvas" width="${width}" height="${height}"></canvas>
          <div class="heatmap-stats">
            <span>${heatmapTotalClicks.toLocaleString()} total clicks</span>
          </div>
        </div>
      `

      const canvas = document.getElementById('heatmap-canvas')
      const ctx = canvas.getContext('2d')

      // Draw click points as heat
      for (const click of heatmapClicks) {
        const intensity = click.count / maxCount
        const x = (click.x / 100) * width
        const y = (click.y / 100) * height
        drawHeatPoint(ctx, x, y, intensity, 30)
      }

      // Colorize
      colorizeHeatmap(ctx, width, height)
    }

    function drawHeatPoint(ctx, x, y, intensity, radius) {
      const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius)
      gradient.addColorStop(0, `rgba(255, 255, 255, ${intensity * 0.6})`)
      gradient.addColorStop(1, 'rgba(255, 255, 255, 0)')
      ctx.fillStyle = gradient
      ctx.beginPath()
      ctx.arc(x, y, radius, 0, Math.PI * 2)
      ctx.fill()
    }

    function colorizeHeatmap(ctx, width, height) {
      const imageData = ctx.getImageData(0, 0, width, height)
      const data = imageData.data

      for (let i = 0; i < data.length; i += 4) {
        const alpha = data[i + 3]
        if (alpha > 0) {
          const ratio = alpha / 255
          // Blue -> Green -> Yellow -> Red gradient
          if (ratio < 0.25) {
            data[i] = 0
            data[i + 1] = Math.floor(ratio * 4 * 255)
            data[i + 2] = 255
          } else if (ratio < 0.5) {
            data[i] = 0
            data[i + 1] = 255
            data[i + 2] = Math.floor((1 - (ratio - 0.25) * 4) * 255)
          } else if (ratio < 0.75) {
            data[i] = Math.floor((ratio - 0.5) * 4 * 255)
            data[i + 1] = 255
            data[i + 2] = 0
          } else {
            data[i] = 255
            data[i + 1] = Math.floor((1 - (ratio - 0.75) * 4) * 255)
            data[i + 2] = 0
          }
          data[i + 3] = Math.min(255, alpha * 2)
        }
      }

      ctx.putImageData(imageData, 0, 0)
    }

    function renderScrollHeatmap() {
      const container = document.getElementById('heatmap-viz')
      if (!container) return

      if (heatmapScrollData.length === 0) {
        container.innerHTML = `
          <div class="heatmap-empty">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
            </svg>
            <p>No scroll data for this page yet</p>
          </div>
        `
        return
      }

      const getColor = (pct) => {
        if (pct >= 80) return '#10b981'
        if (pct >= 60) return '#34d399'
        if (pct >= 40) return '#fbbf24'
        if (pct >= 20) return '#f97316'
        return '#ef4444'
      }

      // Create depth buckets 0-100 in 10% increments
      const buckets = []
      for (let d = 0; d <= 90; d += 10) {
        const dataPoint = heatmapScrollData.find(s => s.depth === d)
        buckets.push({
          depth: d,
          reachPercentage: dataPoint?.reachPercentage ?? (d === 0 ? 100 : 0),
          avgTimeMs: dataPoint?.avgTimeMs ?? 0
        })
      }

      container.innerHTML = `
        <div class="scroll-heatmap">
          <div class="scroll-stats">
            <div class="scroll-stat">
              <span class="scroll-stat-value">${Math.round(heatmapAvgScrollDepth)}%</span>
              <span class="scroll-stat-label">Avg. Scroll Depth</span>
            </div>
            <div class="scroll-stat">
              <span class="scroll-stat-value">${heatmapTotalSessions.toLocaleString()}</span>
              <span class="scroll-stat-label">Total Sessions</span>
            </div>
          </div>
          <div class="scroll-bars">
            ${buckets.map(b => `
              <div class="scroll-bar-row">
                <span class="scroll-depth-label">${b.depth}%</span>
                <div class="scroll-bar-track">
                  <div class="scroll-bar-fill" style="width:${b.reachPercentage}%;background:${getColor(b.reachPercentage)}"></div>
                </div>
                <span class="scroll-reach-label">${b.reachPercentage}%</span>
              </div>
            `).join('')}
          </div>
          <div class="scroll-legend">
            <span><span class="legend-dot" style="background:#10b981"></span>80%+ reach</span>
            <span><span class="legend-dot" style="background:#fbbf24"></span>40-60% reach</span>
            <span><span class="legend-dot" style="background:#ef4444"></span>&lt;20% reach</span>
          </div>
        </div>
      `
    }

    function renderHeatmapSidebar() {
      const sidebar = document.getElementById('heatmap-sidebar')
      if (!sidebar) return

      if (heatmapViewMode === 'click' && heatmapTopElements.length > 0) {
        const maxClicks = heatmapTopElements[0]?.clicks || 1
        sidebar.innerHTML = `
          <div class="heatmap-panel">
            <h3>Top Clicked Elements</h3>
            <div class="element-list">
              ${heatmapTopElements.slice(0, 15).map(el => `
                <div class="element-item">
                  <div class="element-info">
                    <span class="element-tag">&lt;${el.tag}&gt;</span>
                    <span class="element-selector" title="${el.selector}">${el.selector}</span>
                  </div>
                  <div class="element-stats">
                    <div class="element-bar-track">
                      <div class="element-bar-fill" style="width:${(el.clicks / maxClicks) * 100}%"></div>
                    </div>
                    <span class="element-clicks">${el.clicks}</span>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `
      } else if (heatmapViewMode === 'scroll') {
        sidebar.innerHTML = `
          <div class="heatmap-panel">
            <h3>Scroll Insights</h3>
            <div class="insight-list">
              <div class="insight-item">
                <span class="insight-label">Average scroll depth</span>
                <span class="insight-value">${Math.round(heatmapAvgScrollDepth)}%</span>
              </div>
              <div class="insight-item">
                <span class="insight-label">Sessions analyzed</span>
                <span class="insight-value">${heatmapTotalSessions.toLocaleString()}</span>
              </div>
              <div class="insight-item">
                <span class="insight-label">Reached 50%</span>
                <span class="insight-value">${heatmapScrollData.find(s => s.depth === 50)?.reachPercentage || 0}%</span>
              </div>
              <div class="insight-item">
                <span class="insight-label">Reached bottom</span>
                <span class="insight-value">${heatmapScrollData.find(s => s.depth === 90)?.reachPercentage || 0}%</span>
              </div>
            </div>
          </div>
        `
      } else {
        sidebar.innerHTML = `
          <div class="heatmap-panel">
            <h3>No Data</h3>
            <p class="text-muted">Select a page to view heatmap data</p>
          </div>
        `
      }
    }

    function switchView(view) {
      activeView = view
      document.getElementById('dashboard-view').style.display = view === 'dashboard' ? 'block' : 'none'
      document.getElementById('heatmap-view').style.display = view === 'heatmap' ? 'block' : 'none'
      document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'))
      document.querySelector(`.view-tab[data-view="${view}"]`)?.classList.add('active')

      if (view === 'heatmap' && heatmapPages.length === 0) {
        fetchHeatmapPages()
      }
    }

    function switchHeatmapMode(mode) {
      heatmapViewMode = mode
      document.querySelectorAll('.heatmap-mode-btn').forEach(b => b.classList.remove('active'))
      document.querySelector(`.heatmap-mode-btn[data-mode="${mode}"]`)?.classList.add('active')
      if (selectedHeatmapPage) {
        fetchHeatmapData()
      }
    }

    function selectHeatmapPage(path) {
      selectedHeatmapPage = path
      if (path) {
        fetchHeatmapData()
      }
    }

    function renderDashboard() {
      // Update stats
      document.getElementById('stat-realtime').textContent = formatNumber(stats.realtime)
      document.getElementById('stat-people').textContent = formatNumber(stats.people)
      document.getElementById('stat-views').textContent = formatNumber(stats.views)
      document.getElementById('stat-avgtime').textContent = stats.avgTime
      document.getElementById('stat-bounce').textContent = stats.bounceRate + '%'
      document.getElementById('stat-events').textContent = formatNumber(stats.events)
      document.getElementById('realtime-count').textContent = stats.realtime + ' current visitors'

      // Update pages table
      const pagesBody = document.getElementById('pages-body')
      pagesBody.innerHTML = pages.length ? pages.map(p => `
        <tr>
          <td class="name" title="${p.path}">${p.path}</td>
          <td class="value">${formatNumber(p.entries || 0)}</td>
          <td class="value">${formatNumber(p.visitors || 0)}</td>
          <td class="value">${formatNumber(p.views || 0)}</td>
        </tr>
      `).join('') : '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:1rem">No data</td></tr>'

      // Update referrers table
      const referrersBody = document.getElementById('referrers-body')
      referrersBody.innerHTML = referrers.length ? referrers.map(r => `
        <tr>
          <td class="name" title="${r.source}">${r.source}</td>
          <td class="value">${formatNumber(r.visitors || 0)}</td>
          <td class="value">${formatNumber(r.views || 0)}</td>
        </tr>
      `).join('') : '<tr><td colspan="3" style="text-align:center;color:var(--text-muted);padding:1rem">No data</td></tr>'

      // Update devices table
      const devicesBody = document.getElementById('devices-body')
      devicesBody.innerHTML = deviceTypes.length ? deviceTypes.map(d => `
        <tr>
          <td class="name">${d.type}</td>
          <td class="value">${formatNumber(d.visitors || 0)}</td>
        </tr>
      `).join('') : '<tr><td colspan="2" style="text-align:center;color:var(--text-muted);padding:1rem">No data</td></tr>'

      // Update browsers table
      const browsersBody = document.getElementById('browsers-body')
      browsersBody.innerHTML = browsers.length ? browsers.map(b => `
        <tr>
          <td class="name">${b.name}</td>
          <td class="value">${formatNumber(b.visitors || 0)}</td>
        </tr>
      `).join('') : '<tr><td colspan="2" style="text-align:center;color:var(--text-muted);padding:1rem">No data</td></tr>'

      // Update countries table
      const countriesBody = document.getElementById('countries-body')
      countriesBody.innerHTML = countries.length ? countries.map(c => `
        <tr>
          <td class="name">${c.name}</td>
          <td class="value">${formatNumber(c.visitors || 0)}</td>
        </tr>
      `).join('') : '<tr><td colspan="2" style="text-align:center;color:var(--text-muted);padding:1rem">No data</td></tr>'

      // Update campaigns table
      const campaignsBody = document.getElementById('campaigns-body')
      campaignsBody.innerHTML = campaigns.length ? campaigns.map(c => `
        <tr>
          <td class="name" title="${c.name}">${c.name}</td>
          <td class="value">${formatNumber(c.visitors || 0)}</td>
          <td class="value">${formatNumber(c.views || 0)}</td>
        </tr>
      `).join('') : '<tr><td colspan="3" style="text-align:center;color:var(--text-muted);padding:1rem">No data</td></tr>'

      // Update events section
      const eventsContainer = document.getElementById('events-container')
      eventsContainer.innerHTML = events.length ? `
        <table class="data-table">
          <thead>
            <tr>
              <th>Event Name</th>
              <th style="text-align:right">Count</th>
              <th style="text-align:right">Unique</th>
              <th style="text-align:right">Value</th>
            </tr>
          </thead>
          <tbody>
            ${events.map(e => `
              <tr>
                <td class="name">${e.name}</td>
                <td class="value">${formatNumber(e.count || 0)}</td>
                <td class="value">${formatNumber(e.unique || 0)}</td>
                <td class="value">${e.totalValue ? formatNumber(e.totalValue) : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      ` : `
        <div class="empty-state">
          <p>You haven't created any events yet.</p>
          <a href="#">Learn how to use events</a>
        </div>
      `

      // Render time series chart if data available
      renderChart()
    }

    function renderChart() {
      const canvas = document.getElementById('timeSeriesChart')
      const tooltip = document.getElementById('chartTooltip')
      if (!canvas || !timeSeriesData.length) return

      const ctx = canvas.getContext('2d')
      const rect = canvas.parentElement.getBoundingClientRect()
      canvas.width = rect.width - 48
      canvas.height = 220

      const padding = { top: 20, right: 20, bottom: 50, left: 50 }
      const width = canvas.width - padding.left - padding.right
      const height = canvas.height - padding.top - padding.bottom

      const maxViews = Math.max(...timeSeriesData.map(d => d.views), 1)
      const xScale = width / (timeSeriesData.length - 1 || 1)
      const yScale = height / maxViews

      // Store point positions for hover detection
      const points = timeSeriesData.map((d, i) => ({
        x: padding.left + i * xScale,
        y: padding.top + height - d.views * yScale,
        data: d
      }))

      function draw(hoverIndex = -1) {
        ctx.clearRect(0, 0, canvas.width, canvas.height)

        // Draw grid lines
        ctx.strokeStyle = '#374151'
        ctx.lineWidth = 1
        for (let i = 0; i <= 4; i++) {
          const y = padding.top + (height / 4) * i
          ctx.beginPath()
          ctx.moveTo(padding.left, y)
          ctx.lineTo(padding.left + width, y)
          ctx.stroke()
        }

        // Draw area fill
        ctx.beginPath()
        ctx.fillStyle = 'rgba(129, 140, 248, 0.1)'
        points.forEach((p, i) => {
          if (i === 0) {
            ctx.moveTo(p.x, padding.top + height)
            ctx.lineTo(p.x, p.y)
          } else {
            ctx.lineTo(p.x, p.y)
          }
        })
        ctx.lineTo(points[points.length - 1].x, padding.top + height)
        ctx.closePath()
        ctx.fill()

        // Draw line
        ctx.beginPath()
        ctx.strokeStyle = '#818cf8'
        ctx.lineWidth = 2
        points.forEach((p, i) => {
          if (i === 0) ctx.moveTo(p.x, p.y)
          else ctx.lineTo(p.x, p.y)
        })
        ctx.stroke()

        // Draw data points
        points.forEach((p, i) => {
          ctx.beginPath()
          ctx.fillStyle = i === hoverIndex ? '#ffffff' : '#818cf8'
          ctx.arc(p.x, p.y, i === hoverIndex ? 6 : 3, 0, Math.PI * 2)
          ctx.fill()
          if (i === hoverIndex) {
            ctx.strokeStyle = '#818cf8'
            ctx.lineWidth = 2
            ctx.stroke()
          }
        })

        // Draw Y axis labels
        ctx.fillStyle = '#6b7280'
        ctx.font = '11px -apple-system, sans-serif'
        ctx.textAlign = 'right'
        for (let i = 0; i <= 4; i++) {
          const value = Math.round(maxViews - (maxViews / 4) * i)
          const y = padding.top + (height / 4) * i
          ctx.fillText(formatNumber(value), padding.left - 10, y + 4)
        }

        // Draw X axis labels
        ctx.textAlign = 'center'
        ctx.fillStyle = '#6b7280'
        const labelCount = Math.min(timeSeriesData.length, 7)
        const step = Math.max(1, Math.floor((timeSeriesData.length - 1) / (labelCount - 1)))
        for (let i = 0; i < timeSeriesData.length; i += step) {
          const d = timeSeriesData[i]
          const x = padding.left + i * xScale
          const dateStr = formatChartDate(d.date)
          ctx.fillText(dateStr, x, canvas.height - 10)
        }
        // Always show last label if not already shown
        if ((timeSeriesData.length - 1) % step !== 0) {
          const d = timeSeriesData[timeSeriesData.length - 1]
          const x = padding.left + (timeSeriesData.length - 1) * xScale
          ctx.fillText(formatChartDate(d.date), x, canvas.height - 10)
        }

        // Draw vertical hover line
        if (hoverIndex >= 0) {
          ctx.beginPath()
          ctx.strokeStyle = 'rgba(129, 140, 248, 0.5)'
          ctx.lineWidth = 1
          ctx.setLineDash([4, 4])
          ctx.moveTo(points[hoverIndex].x, padding.top)
          ctx.lineTo(points[hoverIndex].x, padding.top + height)
          ctx.stroke()
          ctx.setLineDash([])
        }
      }

      function formatChartDate(dateStr) {
        const date = new Date(dateStr)
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
        return months[date.getMonth()] + ' ' + date.getDate()
      }

      // Initial draw
      draw()

      // Hover interaction
      canvas.onmousemove = function(e) {
        const canvasRect = canvas.getBoundingClientRect()
        const mouseX = e.clientX - canvasRect.left
        const mouseY = e.clientY - canvasRect.top

        // Find closest point
        let closestIdx = -1
        let closestDist = 30 // Max distance to trigger hover
        points.forEach((p, i) => {
          const dist = Math.abs(mouseX - p.x)
          if (dist < closestDist) {
            closestDist = dist
            closestIdx = i
          }
        })

        if (closestIdx >= 0) {
          const p = points[closestIdx]
          const d = p.data
          tooltip.innerHTML = `
            <div class="tooltip-date">${formatChartDate(d.date)}</div>
            <div class="tooltip-row"><span class="tooltip-dot views"></span>Views: <strong>${formatNumber(d.views)}</strong></div>
            <div class="tooltip-row"><span class="tooltip-dot visitors"></span>Visitors: <strong>${formatNumber(d.visitors || 0)}</strong></div>
          `
          tooltip.style.display = 'block'
          // Position tooltip
          let left = p.x + 10
          if (left + 150 > canvas.width) left = p.x - 160
          tooltip.style.left = left + 'px'
          tooltip.style.top = (p.y - 30) + 'px'
          draw(closestIdx)
          canvas.style.cursor = 'pointer'
        } else {
          tooltip.style.display = 'none'
          draw()
          canvas.style.cursor = 'default'
        }
      }

      canvas.onmouseleave = function() {
        tooltip.style.display = 'none'
        draw()
      }
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
      if (siteId) {
        // Site ID provided - show dashboard directly
        document.getElementById('site-selector-screen').style.display = 'none'
        document.getElementById('dashboard-content').style.display = 'block'
        fetchDashboardData()
        // Refresh realtime every 30 seconds
        setInterval(fetchDashboardData, 30000)
      } else {
        // No site ID - show site selector
        document.getElementById('site-selector-screen').style.display = 'flex'
        document.getElementById('dashboard-content').style.display = 'none'
        fetchAvailableSites()
      }
    })
  </script>
  <style>
    :root {
      --bg-primary: #1a1f2e;
      --bg-secondary: #242938;
      --bg-tertiary: #2d3344;
      --text-primary: #ffffff;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --accent: #818cf8;
      --accent-hover: #6366f1;
      --success: #10b981;
      --border: #374151;
      --chart-line: #818cf8;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }

    .dashboard {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1rem;
    }

    .site-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .site-selector select {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.875rem;
      cursor: pointer;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .realtime-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--bg-secondary);
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.875rem;
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .icon-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .icon-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    /* Date Range Bar */
    .date-bar {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 0;
      margin-bottom: 1rem;
    }

    .date-select {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.875rem;
      cursor: pointer;
    }

    .date-bar span {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    /* Summary Stats */
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: var(--bg-secondary);
      padding: 1.25rem;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Chart */
    .chart-container {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      min-height: 250px;
    }

    .chart-placeholder {
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .chart-tooltip {
      display: none;
      position: absolute;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      font-size: 0.8125rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      z-index: 100;
      min-width: 140px;
    }

    .tooltip-date {
      color: var(--text-secondary);
      font-size: 0.75rem;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .tooltip-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
      margin: 0.25rem 0;
    }

    .tooltip-row strong {
      color: var(--text-primary);
      margin-left: auto;
    }

    .tooltip-dot {
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }

    .tooltip-dot.views {
      background: var(--accent);
    }

    .tooltip-dot.visitors {
      background: var(--success);
    }

    /* Data Grid */
    .data-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .data-panel {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 1rem;
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .panel-title {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.25rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1rem;
    }

    .tab-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
    }

    .tab-btn:hover {
      color: var(--text-primary);
    }

    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* Data Table */
    .data-table {
      width: 100%;
      font-size: 0.8125rem;
    }

    .data-table th {
      text-align: left;
      color: var(--text-muted);
      font-weight: 500;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .data-table td {
      padding: 0.625rem 0;
      border-bottom: 1px solid var(--bg-tertiary);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table .name {
      color: var(--text-primary);
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .data-table .value {
      color: var(--text-secondary);
      text-align: right;
    }

    /* Events Section */
    .events-section {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 1.5rem;
    }

    .events-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .events-title {
      font-size: 0.875rem;
      font-weight: 500;
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }

    .empty-state p {
      margin-bottom: 1rem;
    }

    .empty-state a {
      color: var(--accent);
      text-decoration: none;
    }

    .empty-state a:hover {
      text-decoration: underline;
    }

    /* View Tabs */
    .view-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .view-tab {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .view-tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .view-tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Heatmap Section */
    .heatmap-container {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 1rem;
    }

    .heatmap-main {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .heatmap-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: var(--bg-secondary);
      padding: 1rem;
      border-radius: 8px;
    }

    .heatmap-controls select {
      flex: 1;
      max-width: 400px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.875rem;
    }

    .heatmap-mode-btns {
      display: flex;
      gap: 0.25rem;
      background: var(--bg-tertiary);
      padding: 0.25rem;
      border-radius: 6px;
    }

    .heatmap-mode-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .heatmap-mode-btn:hover {
      color: var(--text-primary);
    }

    .heatmap-mode-btn.active {
      background: var(--accent);
      color: white;
    }

    .heatmap-viz-container {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 1rem;
      min-height: 540px;
    }

    .heatmap-loading, .heatmap-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 500px;
      color: var(--text-muted);
      gap: 1rem;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .heatmap-canvas-container {
      position: relative;
    }

    .heatmap-stats {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      background: rgba(0,0,0,0.7);
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-size: 0.75rem;
      color: white;
    }

    /* Scroll Heatmap */
    .scroll-heatmap {
      padding: 1rem;
    }

    .scroll-stats {
      display: flex;
      gap: 2rem;
      margin-bottom: 1.5rem;
    }

    .scroll-stat {
      display: flex;
      flex-direction: column;
    }

    .scroll-stat-value {
      font-size: 1.75rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .scroll-stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .scroll-bars {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .scroll-bar-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .scroll-depth-label {
      width: 40px;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: right;
    }

    .scroll-bar-track {
      flex: 1;
      height: 24px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
    }

    .scroll-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .scroll-reach-label {
      width: 50px;
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .scroll-legend {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .legend-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 2px;
      margin-right: 0.375rem;
    }

    /* Heatmap Sidebar */
    .heatmap-sidebar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .heatmap-panel {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 1rem;
    }

    .heatmap-panel h3 {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }

    .element-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .element-item {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
    }

    .element-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .element-tag {
      font-size: 0.6875rem;
      font-family: monospace;
      color: var(--accent);
      background: var(--bg-tertiary);
      padding: 0.125rem 0.375rem;
      border-radius: 3px;
    }

    .element-selector {
      font-size: 0.75rem;
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 200px;
    }

    .element-stats {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .element-bar-track {
      flex: 1;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
    }

    .element-bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
    }

    .element-clicks {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-primary);
      min-width: 40px;
      text-align: right;
    }

    .insight-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .insight-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--bg-tertiary);
    }

    .insight-item:last-child {
      border-bottom: none;
    }

    .insight-label {
      font-size: 0.8125rem;
      color: var(--text-secondary);
    }

    .insight-value {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .text-muted {
      color: var(--text-muted);
      font-size: 0.8125rem;
    }

    /* Site Selector Screen */
    .site-selector-screen {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .site-selector-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .site-selector-header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .site-selector-header p {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .site-selector-container {
      width: 100%;
      max-width: 600px;
    }

    .site-selector-loading,
    .site-selector-error,
    .site-selector-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem;
      text-align: center;
      color: var(--text-muted);
      gap: 1rem;
    }

    .site-selector-error button,
    .site-selector-empty button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.5rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }

    .site-selector-empty h2 {
      font-size: 1.125rem;
      color: var(--text-primary);
      margin: 0;
    }

    .site-selector-grid {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .site-card {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.25rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      text-align: left;
      width: 100%;
    }

    .site-card:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent);
    }

    .site-card-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border-radius: 8px;
      color: var(--accent);
    }

    .site-card-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .site-card-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    .site-card-domain {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-family: monospace;
    }

    .site-card-arrow {
      color: var(--text-muted);
    }

    .site-card:hover .site-card-arrow {
      color: var(--accent);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .summary-stats {
        grid-template-columns: repeat(3, 1fr);
      }
      .data-grid {
        grid-template-columns: 1fr;
      }
      .heatmap-container {
        grid-template-columns: 1fr;
      }
      .heatmap-sidebar {
        order: -1;
      }
    }

    @media (max-width: 640px) {
      .summary-stats {
        grid-template-columns: repeat(2, 1fr);
      }
      .header {
        flex-direction: column;
        gap: 1rem;
      }
      .heatmap-controls {
        flex-direction: column;
        align-items: stretch;
      }
      .heatmap-controls select {
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <!-- Site Selector Screen (shown when no siteId) -->
  <div id="site-selector-screen" class="site-selector-screen" style="display:none">
    <div class="site-selector-header">
      <h1>Analytics Dashboard</h1>
      <p>Select a site to view analytics</p>
    </div>
    <div id="site-selector-container" class="site-selector-container">
      <div class="site-selector-loading">
        <div class="spinner"></div>
        <p>Loading sites...</p>
      </div>
    </div>
  </div>

  <!-- Dashboard Content -->
  <div id="dashboard-content" class="dashboard" style="display:none">
    <!-- Header -->
    <header class="header">
      <div class="site-selector">
        <select>
          <option>{{ siteName }}</option>
        </select>
      </div>
      <div class="header-actions">
        <div class="realtime-badge">
          <span class="pulse-dot"></span>
          <span id="realtime-count">0 current visitors</span>
        </div>
        <button class="icon-btn" title="Notifications">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
          </svg>
        </button>
        <button class="icon-btn" title="Settings">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- View Tabs -->
    <div class="view-tabs">
      <button class="view-tab active" data-view="dashboard" onclick="switchView('dashboard')">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display:inline;vertical-align:middle;margin-right:0.375rem">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
        </svg>
        Dashboard
      </button>
      <button class="view-tab" data-view="heatmap" onclick="switchView('heatmap')">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display:inline;vertical-align:middle;margin-right:0.375rem">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"/>
        </svg>
        Heatmaps
      </button>
    </div>

    <!-- Dashboard View -->
    <div id="dashboard-view">

    <!-- Date Range Bar -->
    <div class="date-bar">
      <select class="date-select">
        <option>Last 30 days</option>
        <option>Last 7 days</option>
        <option>Today</option>
        <option>Yesterday</option>
        <option>Last 12 months</option>
        <option>Custom range</option>
      </select>
      <span>compared to</span>
      <select class="date-select">
        <option>No comparison</option>
        <option>Previous period</option>
        <option>Same period last year</option>
      </select>
      <select class="date-select">
        <option>Auto</option>
        <option>Hourly</option>
        <option>Daily</option>
        <option>Monthly</option>
      </select>
    </div>

    <!-- Summary Stats -->
    <div class="summary-stats">
      <div class="stat-card">
        <div class="stat-value" id="stat-realtime">0</div>
        <div class="stat-label">Realtime</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-people">0</div>
        <div class="stat-label">People</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-views">0</div>
        <div class="stat-label">Views</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-avgtime">00:00</div>
        <div class="stat-label">Avg time</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-bounce">0%</div>
        <div class="stat-label">Bounce</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-events">0</div>
        <div class="stat-label">Events</div>
      </div>
    </div>

    <!-- Time Series Chart -->
    <div class="chart-container" style="position: relative;">
      <canvas id="timeSeriesChart"></canvas>
      <div id="chartTooltip" class="chart-tooltip"></div>
    </div>

    <!-- Data Grid - Row 1 -->
    <div class="data-grid">
      <!-- Pages -->
      <div class="data-panel">
        <div class="panel-header">
          <span class="panel-title">Pages</span>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Path</th>
              <th style="text-align:right">Entries</th>
              <th style="text-align:right">Visitors</th>
              <th style="text-align:right">Views</th>
            </tr>
          </thead>
          <tbody id="pages-body">
            <tr>
              <td colspan="4" style="text-align:center;color:var(--text-muted);padding:1rem">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Referrers / Sources -->
      <div class="data-panel">
        <div class="tabs">
          <button class="tab-btn active" data-tab="referrers">Referrers</button>
          <button class="tab-btn" data-tab="sources">Sources</button>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Source</th>
              <th style="text-align:right">Visitors</th>
              <th style="text-align:right">Views</th>
            </tr>
          </thead>
          <tbody id="referrers-body">
            <tr>
              <td colspan="3" style="text-align:center;color:var(--text-muted);padding:1rem">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Data Grid - Row 2 -->
    <div class="data-grid">
      <!-- Device Types / OS -->
      <div class="data-panel">
        <div class="tabs">
          <button class="tab-btn active" data-tab="types">Device Types</button>
          <button class="tab-btn" data-tab="os">OS</button>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Type</th>
              <th style="text-align:right">Visitors</th>
            </tr>
          </thead>
          <tbody id="devices-body">
            <tr>
              <td colspan="2" style="text-align:center;color:var(--text-muted);padding:1rem">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Browsers -->
      <div class="data-panel">
        <div class="panel-header">
          <span class="panel-title">Browsers</span>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Browser</th>
              <th style="text-align:right">Visitors</th>
            </tr>
          </thead>
          <tbody id="browsers-body">
            <tr>
              <td colspan="2" style="text-align:center;color:var(--text-muted);padding:1rem">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Data Grid - Row 3 -->
    <div class="data-grid">
      <!-- Countries / Regions / Cities -->
      <div class="data-panel">
        <div class="tabs">
          <button class="tab-btn active" data-tab="countries">Countries</button>
          <button class="tab-btn" data-tab="regions">Regions</button>
          <button class="tab-btn" data-tab="cities">Cities</button>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Country</th>
              <th style="text-align:right">Visitors</th>
            </tr>
          </thead>
          <tbody id="countries-body">
            <tr>
              <td colspan="2" style="text-align:center;color:var(--text-muted);padding:1rem">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Campaigns -->
      <div class="data-panel">
        <div class="tabs">
          <button class="tab-btn active" data-tab="campaign">Campaign</button>
          <button class="tab-btn" data-tab="source">Source</button>
          <button class="tab-btn" data-tab="medium">Medium</button>
          <button class="tab-btn" data-tab="content">Content</button>
          <button class="tab-btn" data-tab="term">Term</button>
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Campaign</th>
              <th style="text-align:right">Visitors</th>
              <th style="text-align:right">Views</th>
            </tr>
          </thead>
          <tbody id="campaigns-body">
            <tr>
              <td colspan="3" style="text-align:center;color:var(--text-muted);padding:1rem">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Events Section -->
    <div class="events-section">
      <div class="events-header">
        <span class="events-title">Events</span>
      </div>
      <div id="events-container">
        <div class="empty-state">
          <p>Loading events...</p>
        </div>
      </div>
    </div>

    </div><!-- End Dashboard View -->

    <!-- Heatmap View -->
    <div id="heatmap-view" style="display:none">
      <div class="heatmap-container">
        <div class="heatmap-main">
          <!-- Controls -->
          <div class="heatmap-controls">
            <select id="heatmap-page-select" onchange="selectHeatmapPage(this.value)">
              <option value="">Select a page...</option>
            </select>
            <div class="heatmap-mode-btns">
              <button class="heatmap-mode-btn active" data-mode="click" onclick="switchHeatmapMode('click')">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display:inline;vertical-align:middle;margin-right:0.25rem">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                </svg>
                Clicks
              </button>
              <button class="heatmap-mode-btn" data-mode="scroll" onclick="switchHeatmapMode('scroll')">
                <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display:inline;vertical-align:middle;margin-right:0.25rem">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>
                </svg>
                Scroll
              </button>
            </div>
            <button class="icon-btn" title="Refresh" onclick="fetchHeatmapData()">
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
            </button>
          </div>

          <!-- Visualization -->
          <div class="heatmap-viz-container">
            <div id="heatmap-viz">
              <div class="heatmap-empty">
                <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/>
                </svg>
                <p>Select a page to view its heatmap</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="heatmap-sidebar" id="heatmap-sidebar">
          <div class="heatmap-panel">
            <h3>Getting Started</h3>
            <p class="text-muted">Select a page from the dropdown to view click or scroll heatmaps. Heatmap data is collected from user interactions on your site.</p>
          </div>
        </div>
      </div>
    </div>

  </div><!-- End dashboard-content -->

  <script>
    // Tab switching logic
    document.querySelectorAll('.tabs').forEach(tabContainer => {
      const buttons = tabContainer.querySelectorAll('.tab-btn')
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          buttons.forEach(b => b.classList.remove('active'))
          btn.classList.add('active')
        })
      })
    })

    // Handle window resize for chart
    window.addEventListener('resize', () => {
      if (timeSeriesData.length) renderChart()
    })
  </script>
</body>
</html>
