<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics Dashboard</title>
  <script src="./scripts/dashboard.ts"></script>
  @include('../components/dashboard/DashboardStyles.stx')
</head>
<body>
  <stx-loading-indicator color="var(--accent)" height="3px" />
  @include('../components/dashboard/SiteSelector.stx')

  <div id="dashboard" class="min-h-screen flex flex-col" style="display:none">
    @include('../components/dashboard/DashboardHeader.stx')
    @include('../components/dashboard/ControlsBar.stx')
    @include('../components/dashboard/FiltersBar.stx')
    @include('../components/dashboard/StatsRow.stx')

    <script>
      // Immediately populate from cache before any other JS runs
      (function() {
        try {
          var urlParams = new URLSearchParams(window.location.search);
          var siteId = urlParams.get('siteId') || window.ANALYTICS_SITE_ID || '';
          if (!siteId) return;
          var cached = localStorage.getItem('ts-analytics-stats-' + siteId);
          if (!cached) return;
          var data = JSON.parse(cached);
          if (!data.timestamp || Date.now() - data.timestamp > 24 * 60 * 60 * 1000) return;
          var s = data.stats;
          var fmt = function(n) { return n >= 1000 ? (n/1000).toFixed(1) + 'k' : String(n); };
          if (s.realtime !== undefined) document.getElementById('stat-realtime').textContent = fmt(s.realtime);
          if (s.sessions !== undefined) document.getElementById('stat-sessions').textContent = fmt(s.sessions);
          if (s.people !== undefined) document.getElementById('stat-people').textContent = fmt(s.people);
          if (s.views !== undefined) document.getElementById('stat-views').textContent = fmt(s.views);
          if (s.avgTime !== undefined) document.getElementById('stat-avgtime').textContent = s.avgTime;
          if (s.bounceRate !== undefined) document.getElementById('stat-bounce').textContent = s.bounceRate + '%';
        } catch(e) {}
      })();
    </script>

    @include('../components/dashboard/NoDataMessage.stx')

    <div id="main-content" class="flex-1 p-6 max-w-[1400px] mx-auto w-full">
      @include('../components/dashboard/ChartSection.stx')

      <div id="dashboard-panels">
        <!-- Row 1: Pages & Referrers -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <pages-panel />
          <referrers-panel />
        </div>

        <!-- Row 2: Devices & Browsers -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <devices-panel />
          <browsers-panel />
        </div>

        <!-- Row 3: Countries & Campaigns -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <countries-panel />
          <campaigns-panel />
        </div>

        <!-- Events Section -->
        <div class="mb-6">
          <events-panel />
        </div>

        <!-- Goals Section -->
        <goals-panel />
      </div>

      <!-- Tab Content Area - Each tab component is shown/hidden by switchTab() -->
      <div id="tab-sessions" class="tab-view hidden"><sessions-tab /></div>
      <div id="tab-vitals" class="tab-view hidden"><vitals-tab /></div>
      <div id="tab-errors" class="tab-view hidden"><errors-tab /></div>
      <div id="tab-insights" class="tab-view hidden"><insights-tab /></div>
      <div id="tab-live" class="tab-view hidden"><live-tab /></div>
      <div id="tab-funnels" class="tab-view hidden"><funnels-tab /></div>
      <div id="tab-flow" class="tab-view hidden"><flow-tab /></div>
      <div id="tab-settings" class="tab-view hidden"><settings-tab /></div>
    </div>

    @include('../components/dashboard/GoalModal.stx')
    @include('../components/Modal.stx')
    @include('../components/SessionModal.stx')
  </div>

  <!-- Panel Components (custom elements defined by these includes) -->
  @include('../components/dashboard/PagesPanel.stx')
  @include('../components/dashboard/ReferrersPanel.stx')
  @include('../components/dashboard/DevicesPanel.stx')
  @include('../components/dashboard/BrowsersPanel.stx')
  @include('../components/dashboard/CountriesPanel.stx')
  @include('../components/dashboard/CampaignsPanel.stx')
  @include('../components/dashboard/EventsPanel.stx')
  @include('../components/dashboard/GoalsPanel.stx')

  <!-- Tab Components (custom elements defined by these includes) -->
  @include('../components/tabs/SessionsTab.stx')
  @include('../components/tabs/VitalsTab.stx')
  @include('../components/tabs/LiveTab.stx')
  @include('../components/tabs/ErrorsTab.stx')
  @include('../components/tabs/FunnelsTab.stx')
  @include('../components/tabs/InsightsTab.stx')
  @include('../components/tabs/FlowTab.stx')
  @include('../components/tabs/SettingsTab.stx')
  @include('../components/shared/EmptyStates.stx')
</body>
</html>
