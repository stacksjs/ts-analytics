<script server>
export const siteId = props.siteId || 'test-site'
export const apiEndpoint = props.apiEndpoint || ''
</script>

@layout('layouts/base', { title: 'Error Tracking Test - Analytics', containerClass: 'max-w-3xl', siteId, apiEndpoint })

@section('content')
  @component('BackLink', { href: '/dashboard?siteId=' + siteId })
  @endcomponent

  @component('PageHeader', {
    title: 'Error Tracking Test',
    subtitle: 'Site ID: ' + siteId
  })
  @endcomponent

  <div class="bg-gray-800 rounded-lg p-6 mb-6">
    <h2 class="text-lg font-medium mb-2">Test JavaScript Errors</h2>
    <p class="text-gray-400 mb-4">Click the buttons below to trigger different types of JavaScript errors. These will be captured and sent to the analytics API.</p>

    <div class="flex flex-wrap gap-2">
      <button onclick="testSyntaxError()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm font-medium">Syntax Error</button>
      <button onclick="testTypeError()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm font-medium">Type Error</button>
      <button onclick="testReferenceError()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm font-medium">Reference Error</button>
      <button onclick="testCustomError()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm font-medium">Custom Error</button>
      <button onclick="testAsyncError()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm font-medium">Async Error</button>
    </div>
  </div>

  <div class="bg-gray-800 rounded-lg p-6">
    <h2 class="text-lg font-medium mb-4">Event Log</h2>
    <div id="log" class="bg-gray-900 rounded p-4 font-mono text-sm max-h-48 overflow-y-auto">
      <div class="py-1 border-b border-gray-700">Ready to capture errors...</div>
    </div>
  </div>
@endsection

@push('scripts')
<script>
  const API = window.ANALYTICS_API
  const SITE_ID = window.ANALYTICS_SITE_ID

  function log(message, type = 'info') {
    const logEl = document.getElementById('log')
    const entry = document.createElement('div')
    entry.className = 'py-1 border-b border-gray-700 last:border-0'
    if (type === 'error') entry.classList.add('text-red-400')
    if (type === 'success') entry.classList.add('text-green-400')
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
    logEl.appendChild(entry)
    logEl.scrollTop = logEl.scrollHeight
  }

  function testSyntaxError() {
    log('Triggering syntax error...')
    eval('function() {')
  }

  function testTypeError() {
    log('Triggering type error...')
    null.toString()
  }

  function testReferenceError() {
    log('Triggering reference error...')
    undefinedVariable.doSomething()
  }

  function testCustomError() {
    log('Triggering custom error...')
    throw new Error('Test custom error from test page')
  }

  async function testAsyncError() {
    log('Triggering async error...')
    await Promise.reject(new Error('Test async error'))
  }

  window.onerror = function(msg, source, line, col, error) {
    log(`Caught: ${msg}`, 'error')

    fetch(API + '/collect', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        s: SITE_ID,
        e: 'error',
        u: window.location.href,
        p: { message: msg, source, line, col, stack: error?.stack }
      })
    }).then(() => log('Error sent to API', 'success'))
      .catch(err => log('Failed to send error: ' + err.message, 'error'))

    return false
  }

  window.onunhandledrejection = function(event) {
    log(`Unhandled rejection: ${event.reason}`, 'error')

    fetch(API + '/collect', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        s: SITE_ID,
        e: 'error',
        u: window.location.href,
        p: { message: String(event.reason), type: 'unhandledrejection', stack: event.reason?.stack }
      })
    }).then(() => log('Error sent to API', 'success'))
      .catch(err => log('Failed to send error: ' + err.message, 'error'))
  }

  log('Error handlers initialized', 'success')
</script>
@endpush
